# 从零到上线：网站部署全流程（含“为什么”与可迁移思路）

> 目标不是“照抄命令”，而是理解一套可复用的方法：  
> **本地开发 -> 版本管理 -> 远程仓库 -> 云平台部署 -> 环境变量 -> 域名/DNS -> 验证与排错**

---

## 1. 先建立正确认知：你到底在部署什么

你的项目本质上由两部分组成：

1. 前端静态资源  
`index.html`、`css/*`、`js/*`  
作用：浏览器打开页面、展示表单与按钮。

2. 服务端接口（Serverless Functions）  
`api/chat.js`、`api/image.js`、`api/health.js`  
作用：在服务器端调用大模型 API，保护密钥，给前端返回结果。

### 为什么要这样拆

- 如果前端直接拿 API Key 调第三方接口，密钥会暴露在浏览器里。  
- 把 Key 放在服务端环境变量中，前端只请求你自己的 `/api/*`，更安全、可控。  
- 这套结构可迁移到 Vercel、Netlify、Cloudflare、腾讯云函数等，不绑定某个平台。

---

## 2. 为什么要先用 Git：不是形式，是“可回滚”

很多人把“部署”理解成“把文件传上去”。  
工程上更可靠的方法是：

1. 每次改动先本地提交（commit）
2. 推送到远程仓库（GitHub）
3. 云平台基于某次 commit 构建

### 这样做的价值

- 可追溯：出问题知道是哪个版本引入的。
- 可回滚：坏了可以迅速回退上一版。
- 可协作：多人不会互相覆盖文件。

---

## 3. GitHub 新建仓库时，为什么常建议“不勾选 README”

你问得非常关键。

### 原因（对新手最友好）

如果你本地已经有完整项目，再在 GitHub 勾选 README，GitHub 会先创建一个“远程初始提交”。  
这会导致：

- 远程和本地各有独立起点
- 首次 `git push` 可能报错（历史不一致）
- 新手容易走到 `pull/merge/rebase` 分支冲突流程

所以教程里常说“先建空仓库”，目的是降低首次推送门槛。

### 什么时候可以勾选 README

可以勾选，但你要知道后续怎么处理：

1. `git pull origin main --rebase`
2. 解决冲突（如果有）
3. 再 `git push`

换句话说：  
**不勾选 README = 减少第一次学习成本**，不是“绝对不能勾”。

---

## 4. 从本地到 GitHub：每个命令的意义

```powershell
git init
```
- 把当前文件夹变成 Git 仓库（创建 `.git` 元数据）。

```powershell
git add .
```
- 把当前变更加入“暂存区”（准备提交）。

```powershell
git commit -m "deploy: initial release"
```
- 形成一个版本快照（真正记录历史）。

```powershell
git branch -M main
```
- 统一主分支名为 `main`（和 GitHub 默认一致）。

```powershell
git remote add origin https://github.com/用户名/仓库名.git
```
- 告诉本地仓库：远程地址叫 `origin`。

```powershell
git push -u origin main
```
- 把本地 `main` 推到远程。  
- `-u` 表示建立跟踪关系，以后可直接 `git push`。

### 可迁移思路

任何平台（GitLab/Gitee/Bitbucket）本质都一样：  
**本地仓库 + 远程地址 + push 上去**。

---

## 5. Vercel 导入项目：你在做什么

你在 Vercel 点 `Import` 时，本质是：

1. 授权 Vercel 读取 GitHub 仓库
2. 创建一个“部署项目”
3. 每次仓库有新 commit，自动触发构建/部署

### Project Name 为什么要规范

你遇到过变量/命名报错，本质是平台命名规则限制。  
建议统一使用：

- 小写字母 + 数字 + 下划线/短横线（看平台规则）
- 不用中文、不用特殊符号

这能减少跨平台兼容问题。

---

## 6. 环境变量：为什么必须放这里

典型变量：

- `AI_API_KEY`（必须）
- `AI_BASE_URL`
- `AI_CHAT_MODEL`
- `AI_MAX_TOKENS`
- `AI_IMAGE_API_KEY`（可选）
- `AI_IMAGE_BASE_URL`
- `AI_IMAGE_MODEL`

### 为什么不写死在代码里

1. 安全：前端代码会被任何访问者看到。  
2. 灵活：不同环境（开发/测试/生产）可用不同 Key。  
3. 运维友好：换 Key 不用改代码，不用重新提交。

### 识别标准

凡是“可能泄露成本、权限、账号能力”的信息，都不该进前端仓库明文。

---

## 7. 首次部署失败的常见根因（你已经遇到过）

你遇到的错误：

`Function Runtimes must have a valid version...`

### 根因

- `vercel.json` 里的 runtime 配置格式与当前 Vercel 校验不兼容。

### 处理策略

优先简单方案：

1. 删除有问题的自定义 runtime 配置
2. 使用平台默认自动识别

### 举一反三

当你不确定某平台配置是否最新时：

1. 先跑最小可用配置（MVP）
2. 成功后再加高级配置

这比“一开始就堆满配置”更稳。

---

## 8. 先验证 API，再验证页面：排错效率最高

正确验证顺序：

1. `https://你的域名/api/health`
2. 再打开主页测试按钮

### 为什么

如果 API 都没通，前端再怎么点也会失败。  
先看 `/api/health`，可以快速判断：

- 服务端函数是否部署成功
- 环境变量是否生效
- 路由是否正确

这是典型“分层排错”思路。

---

## 9. 自定义域名与 DNS：理解后就不怕了

你在 Vercel 里加域名后出现 `Invalid Configuration`，这很常见。

### 本质在做什么

你在告诉全网 DNS：

- `@`（裸域）请求应指向 Vercel
- `www` 请求也指向 Vercel

常见记录（以 Vercel 页面提示为准）：

- `A` 记录：`@ -> 76.76.21.21`
- `CNAME`：`www -> cname.vercel-dns.com`

### 为什么会 Invalid

常见三类：

1. 记录值填错（最常见）
2. 有冲突记录（同名已有 A/AAAA/CNAME）
3. 尚未全球生效（DNS 传播需要时间）

### 举一反三

任何云平台绑定域名都遵循同一规律：  
**在你的 DNS 供应商后台，按平台给的目标值做映射**。

---

## 10. 手机访问要不要梯子：代码问题还是网络问题

你已经验证 `api/health` 正常，所以功能逻辑没问题。  
手机是否要梯子，往往取决于访问链路（域名与网络环境），不是前端代码。

### 优先顺序

1. 先用自定义域名替代 `*.vercel.app`
2. 确认 DNS 生效并 HTTPS 正常
3. 仍不稳定时再考虑迁到国内云

### 工程判断方法

- 某网络能访问、某网络不能访问：多半是网络/解析链路问题。  
- 所有网络都失败：再重点看代码或服务端配置。

---

## 11. 每次更新上线的标准流程（可长期复用）

```powershell
git add .
git commit -m "feat/fix: 说明本次改动"
git push
```

Vercel 自动部署后：

1. 检查最新 Deployment 是否 `Ready`
2. 打开 `/api/health`
3. 回归关键功能

### 为什么必须有“上线后验证”

CI/CD 只是自动发布，不代表业务一定正确。  
工程上发布完成后，至少做一次“冒烟测试（smoke test）”。

---

## 12. 安全与成本控制（经常被忽略）

1. 密钥泄露立即 rotate（重置）
2. 环境变量最小化权限（能分就分，不共用超大权限 key）
3. 给 API 设预算和告警
4. 控制 `max_tokens`，避免单次请求成本过高
5. 对 `/api/*` 增加限流与基础防刷（后续可做）

---

## 13. 一个“能迁移到任何项目”的部署思维模板

你以后做新项目，可以按这个模板判断：

1. 架构识别  
- 纯静态？  
- 静态 + API 代理？  
- 全后端应用？

2. 安全识别  
- 哪些信息必须留在服务器？

3. 部署单元  
- 代码仓库在哪里？  
- 云平台从哪里拉代码？

4. 运行配置  
- 环境变量有哪些？默认值是什么？

5. 可用性验证  
- 健康接口  
- 核心链路测试

6. 访问链路  
- 域名  
- DNS  
- 证书

7. 运维闭环  
- 日志  
- 告警  
- 回滚

---

## 14. 你这个项目的“最简正确配置清单”

必须：

- GitHub 仓库可用
- Vercel 最新部署 `Ready`
- `AI_API_KEY` 已配置
- `/api/health` 返回 `ok: true`

建议：

- 绑定 `mmxzyx.xyz` 与 `www.mmxzyx.xyz`
- DNS 配置正确并变成 `Valid Configuration`
- 手机端用自定义域名访问

---

## 15. 常用命令速查

```powershell
# 查看当前状态
git status

# 提交并推送
git add .
git commit -m "chore: update"
git push

# 查看远程地址
git remote -v
```

---

## 16. 最后一条建议：把“会做”升级为“会判断”

真正的能力不是记住命令，而是遇到问题时能判断：

1. 这是代码错误？配置错误？还是网络链路问题？
2. 我应该先验证哪一层？
3. 这一步改动对安全和成本有什么影响？

你已经在这个项目里做到了前两步。下一步就是把这套方法变成习惯。

